# PRODUCT OVERVIEW: Middle-earth AI RPG ("Terres du Milieu")

## 1. Vision & Value Proposition
An immersive, rules‑driven tabletop Role‑Playing Game (RPG) set in Middle‑earth, where a Large Language Model (LLM) acts as the dynamic Game Master (GM). The product blends classic character progression, tactical encounters, exploration, narrative improvisation, and data‑validated rules. It lowers the barrier to play by eliminating prep time and enabling solo or small‑group sessions with persistent world state.

**Core Value:** High‑fidelity Tolkien‑inspired adventures with adaptive narration + strict mechanical integrity (stats, skills, combat, equipment, magic) enforced by backend services.

## 2. Target Users
- **Solo Player:** Wants an always‑available GM for narrative + progression.
- **Small Group / Casual Table:** Uses AI GM to accelerate play without a human facilitator.
- **Scenario Author / Content Curator:** Adds or tweaks Markdown scenarios; relies on system for continuity and mechanics.
- **Experimental Dev / Extender:** Integrates new rulesets or tools via service & agent layer.

## 3. What the Product Does (Functional Scope)
1. **Character Lifecycle:** Create, validate, persist, and evolve player characters (stats allocation, skills, equipment, spells, money, XP, injuries).  
2. **Scenario Play:** Load structured narrative scenarios (Markdown) and progress through them via conversational turns with the GM agent.  
3. **Adaptive Narration:** LLM GM augments player intent with rules context (skill checks, combat resolution, inventory effects).  
4. **Rules Enforcement:** Deterministic services handle combat math, stat costs, skill validation, equipment constraints, spell access.  
5. **Combat System:** Initiative, turn structure, actions and damage resolution managed with transparent state persistence.  
6. **Inventory & Economy:** Buy/sell equipment, manage gold, apply item effects.  
7. **Magic & Skills:** Structured YAML data defines available spells and skill groupings; used for checks & growth.  
8. **Session Persistence:** Each play session stores chronological message history (JSONL) enabling rewind, auditing, or pruning.  
9. **Multi‑Scenario Availability:** Enumerate available scenarios; prevent duplicate session conflicts per character/scenario combination.  
10. **Content Extensibility:** New races, cultures, equipment, spells, or scenarios added via YAML/Markdown without code changes.

## 4. Key Feature Detail
### Character Creation Workflow
- Guided multi‑step process: race → culture → stat allocation (budget with scaling cost) → skill distribution → equipment → naming & flavor (names, backgrounds, physical descriptions generated by LLM).  
- Automatic validation (point caps, legal ranges, race/culture bonuses).  
- Finalization locks baseline attributes; progression then applies via XP and earned rewards.

### AI Game Master Interaction
- Player sends natural language intents; system enriches prompt with character, combat, and scenario context.  
- LLM may invoke tools (skill check, damage application, inventory change).  
- Output separated into narrative vs. mechanical consequences.

### Structured Data Backbone
- All rule data (stats, skills, races, equipment, spells, combat rules) in YAML for transparency & modding.  
- Services insulate the agent from raw file I/O—ensuring consistency and preventing narrative drift from rules.

### Combat Encounters
- Initiative roll (AGI modifier + dice).  
- Turn loop tracks round, active participant, actions, HP changes, log of events.  
- Attack resolution: attack vs defense differential influences damage.  
- End conditions and rewards applied cleanly; state saved.

### Scenario Engine
- Markdown scenario files supply structured beats, lore, branching cues.  
- Session start binds character + scenario; prevents duplicate in‑progress conflicts.  
- History endpoint allows reconstruction or summarization.

### Persistence & Auditing
- JSONL message files store every user/assistant/tool interaction (excluding repeated system prompts).  
- Enables debugging, moderation, or rollback (e.g. delete one message and regenerate from earlier state).

## 5. User Journeys
### A. New Player Solo Session
1. Opens creation flow, selects race & culture.  
2. Allocates 400 stat points (cost‑scaled) + 40 skill points across groups.  
3. Buys starting equipment with gold; validates distribution.  
4. Generates name & background; finalizes character.  
5. Chooses scenario → starts session → explores via chat.  
6. Performs a stealth check; tool invoked → result narrated.  
7. Gains XP, receives loot; character persisted.

### B. Returning Player
1. Lists characters; selects existing.  
2. Resumes scenario session (history loaded).  
3. Continues combat mid‑round; agent references stored combat state.  
4. Ends session; progress saved.

### C. Scenario Author
1. Adds new `*.md` scenario file with structured sections & cues.  
2. Tests flow locally; verifies agent adapts and invokes appropriate tools.  
3. Adjusts YAML data for special equipment needed; no code changes required.

## 6. Data & Persistence Model
- **Characters:** JSON files (versionable, human‑readable).  
- **Sessions:** JSONL sequential message log.  
- **Combat States:** Stored per active encounter for continuity.  
- **Rules Data:** YAML managers loaded at runtime (fail‑fast if malformed).  
- **Scenarios:** Markdown narrative sources.

## 7. Differentiators
- Hybrid: Freeform narrative + hardened rules logic (services guarantee fairness).  
- Zero‑prep: Instant scenario launch for solo or group play.  
- Extensible via data (no code fork for new content).  
- Transparent auditing of AI decisions through tool call logs.

## 8. Non‑Goals (Current)
- Real‑time multi‑user synchronization (single active player focus per session).  
- Full graphical combat visualization (text & structured logs only).  
- Canon‑enforced lore licensing (inspired setting without official IP claims).  
- Competitive PvP balancing (cooperative narrative orientation).

## 9. Current Product Maturity
- Refactored v2 core (simplified stats & skills).  
- YAML migration complete; LLM tooling integrated via PydanticAI.  
- Core creation, combat, inventory, magic functional.  
- Frontend demo with character sheet & chat experience.

## 10. Near-Term Roadmap Snapshot
| Horizon | Focus | Outcome |
|---------|-------|---------|
| 0‑2 mo  | Complete CharacterV2 adoption front/back | Unified progression & UI clarity |
| 0‑2 mo  | Enhanced error & validation surfaces | Better player guidance |
| 2‑4 mo  | NPC generation & archetypes | Richer encounters |
| 2‑4 mo  | Combat state manager refinements | Smoother mid-session recovery |
| 3‑6 mo  | Multi-player session support | Group storytelling |
| 3‑6 mo  | WebSocket real-time channel | Lower latency interactions |

## 11. Success Metrics (Indicative)
- Time from create to first scenario < 5 minutes.  
- >70% of sessions invoke at least one rules tool (shows mechanical engagement).  
- Scenario completion rate >40% for new players.  
- <5% validation failure rate after finalization step.  
- Data‑only content additions adopted without code change in ≥90% cases.

## 12. Expansion Vectors
- Additional fantasy settings via data pack swap.  
- Visual map & turn tracker integration.  
- Community scenario marketplace (curation + rating).  
- Optional human co‑GM mode.

## 13. Summary
"Terres du Milieu" delivers a **rule‑faithful yet flexible AI‑driven RPG experience**: immediate play, persistent character growth, transparent mechanics, and extensible world content—all powered by a clean separation of narration (LLM) and enforcement (services + data managers). This foundation enables sustainable expansion without sacrificing fairness or immersion.
