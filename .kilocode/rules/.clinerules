# R√®gles Cline pour le projet JdR "Terres du Milieu"

## üéØ **PROJET : JdR orchestr√© par LLM**
**Stack :** FastAPI + PydanticAI + Vue.js + TypeScript
**Objectif :** Syst√®me de jeu de r√¥le avec Ma√Ætre du Jeu LLM

---

## üèóÔ∏è **ARCHITECTURE ET STRUCTURE**

### Organisation des fichiers
```
back/           # Backend FastAPI + PydanticAI
‚îú‚îÄ‚îÄ agents/     # Agents LLM PydanticAI
‚îú‚îÄ‚îÄ services/   # Logique m√©tier (SRP strict)
‚îú‚îÄ‚îÄ routers/    # Endpoints REST FastAPI
‚îú‚îÄ‚îÄ tools/      # Outils PydanticAI
‚îú‚îÄ‚îÄ models/     # Sch√©mas Pydantic
‚îî‚îÄ‚îÄ storage/    # Persistance JSONL

front/          # Frontend Vue.js + TypeScript
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/ # Composants r√©utilisables
‚îÇ   ‚îú‚îÄ‚îÄ views/      # Pages de l'application
‚îÇ   ‚îî‚îÄ‚îÄ core/       # Services et interfaces
```

### Principes architecturaux
- **SRP strict** : Un service = une responsabilit√©
- **S√©paration des couches** : Routers ‚Üí Services ‚Üí Agents ‚Üí Tools
- **Typage fort** : Pydantic pour le backend, TypeScript pour le frontend
- **M√©moire d√©coupl√©e** : Stockage JSONL via PydanticAI

---

## üîß **CONVENTIONS DE D√âVELOPPEMENT**

### Backend (Python/FastAPI/PydanticAI)

#### Agents PydanticAI
```python
# ‚úÖ CORRECT
from pydantic_ai import Agent, RunContext

def create_agent(model: str) -> Agent:
    agent = Agent(
        model=model,
        deps_type=UserContext,
        output_type=StructuredResponse,
        retries=2
    )
    
    @agent.tool
    async def my_tool(ctx: RunContext[UserContext], param: str) -> dict:
        # Logique m√©tier
        return {"result": "data"}
    
    return agent
```

#### Services
- **Nommage** : `{domain}_service.py` (ex: `character_service.py`)
- **Instance-based** : Services instanci√©s avec contexte
- **Pas de logique HTTP** dans les services
- **Validation Pydantic** pour tous les inputs/outputs

#### Routers FastAPI
- **Responsabilit√© unique** : Gestion HTTP uniquement
- **D√©l√©gation** : Toute logique m√©tier d√©l√©gu√©e aux services
- **Documentation** : Docstrings compl√®tes avec exemples

### Frontend (Vue.js/TypeScript)

#### Composants
- **Composition API** : Utiliser `<script setup>`
- **Typage strict** : Interfaces TypeScript pour toutes les props
- **Props** : Validation avec `defineProps<T>()`
- **√âv√©nements** : `defineEmits<T>()`

#### Services API
- **Interfaces centralis√©es** : `front/src/core/interfaces.ts`
- **Validation UUID** : Toujours valider les IDs
- **Gestion d'erreurs** : Typ√©e avec `ApiErrorResponse`

---

## üö® **R√àGLES CRITIQUES - NE JAMAIS VIOLER**

### Organisation des fichiers
- ‚ùå **NE JAMAIS** cr√©er de fichiers √† la racine (sauf configuration)
- ‚ùå **NE JAMAIS** m√©langer les responsabilit√©s entre couches
- ‚úÖ **TOUJOURS** respecter la structure modulaire

### PydanticAI - Patterns obligatoires
```python
# ‚úÖ CORRECT - Acc√®s direct aux objets Pydantic
result.output.chunks  # ‚úÖ
result.data.model_dump().get("chunks")  # ‚ùå ANTI-PATTERN

# ‚úÖ CORRECT - Structured output
agent = Agent(model, output_type=MyModel)  # ‚úÖ
agent = Agent(model)  # ‚ùå (sans structured output)
```

### Gestion des donn√©es
- **Personnages** : Format JSON racine (pas de cl√© `state`)
- **Historique** : JSONL via `pydantic_jsonl_store.py`
- **Sc√©narios** : Markdown dans `data/scenarios/`

---

## üõ†Ô∏è **OUTILS ET PATTERNS SP√âCIFIQUES**

### Outils PydanticAI existants
- `skill_tools.py` : Tests de comp√©tences
- `combat_tools.py` : Syst√®me de combat complet
- `inventory_tools.py` : Gestion d'inventaire
- `character_tools.py` : Gestion des personnages

### Patterns de cr√©ation d'outils
```python
@agent.tool
async def my_tool(
    ctx: RunContext[UserContext],
    param: str = Field(description="Description claire")
) -> Dict[str, Any]:
    """
    Description de l'outil.
    
    Args:
        param: Description du param√®tre
        
    Returns:
        Structure de retour document√©e
    """
    # Acc√®s aux d√©pendances
    character_service = ctx.deps.character_service
    # Logique m√©tier
    return {"result": "data"}
```

### Gestion des sessions
- **Pr√©vention des doublons** : V√©rification `character_name + scenario_name`
- **Statut personnage** : V√©rifier `status !== "en_cours"` avant jeu
- **Historique** : Gestion via `SessionService`

---

## üß™ **TESTS ET QUALIT√â**

### Organisation des tests
```
back/tests/
‚îú‚îÄ‚îÄ agents/     # Tests PydanticAI
‚îú‚îÄ‚îÄ services/   # Tests m√©tier
‚îú‚îÄ‚îÄ routers/    # Tests API
‚îú‚îÄ‚îÄ tools/      # Tests outils
‚îî‚îÄ‚îÄ integration/# Tests d'int√©gration
```

### R√®gles de test
- **Mocking obligatoire** : Redis, LightRAG, OpenAI, Neo4j
- **Tests asynchrones** : `pytest-asyncio` pour async/await
- **Couverture** : ‚â•80% pour les services critiques
- **Nettoyage** : Sessions de test automatiquement nettoy√©es

### Frontend tests
- **Vitest** : Framework de test
- **Composants** : Tests unitaires pour tous les composants
- **Services API** : Tests avec mocks

---

## üîÑ **WORKFLOWS DE D√âVELOPPEMENT**

### Ajout d'un nouvel endpoint
1. Mod√®le Pydantic dans `models/schema.py`
2. Service dans `services/{domain}_service.py`
3. Route dans `routers/{domain}.py`
4. Tests dans `tests/routers/` et `tests/services/`

### Ajout d'un nouvel agent PydanticAI
1. Mod√®les de r√©ponse dans `models/schema.py`
2. Agent dans `agents/{agent_name}.py`
3. Outils dans `tools/{domain}_tools.py`
4. Registration dans `services/llm_service.py`
5. Tests complets

### Modification des donn√©es de jeu
- **Comp√©tences** : `data/skills_for_llm.json`
- **Races/cultures** : `data/races_and_cultures.json`
- **√âquipement** : `data/equipment.json`
- **Scripts** : `tools/` pour la g√©n√©ration automatique

---

## ‚ö†Ô∏è **PROBL√àMES COURANTS ET SOLUTIONS**

### Boucles infinies LLM
- **Cause** : Agent qui ne respecte pas la structure des tours
- **Solution** : Instructions structur√©es dans le prompt syst√®me

### Sessions dupliqu√©es
- **Cause** : M√™me personnage + sc√©nario
- **Solution** : V√©rification dans `ScenarioService.start_scenario()`

### Format personnage obsol√®te
- **Cause** : Cl√© `state` dans les JSON
- **Solution** : Format racine uniquement

---

## üöÄ **COMMANDES DE D√âVELOPPEMENT**

### Installation et lancement
```bash
# Backend
cd back && python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
uvicorn main:app --reload

# Frontend  
cd front && npm install
npm run dev
```

### Tests
```bash
# Backend
cd back && pytest tests/ -v

# Frontend
cd front && npm test
```

### Qualit√© de code
```bash
# Backend
ruff check back/
black back/

# Frontend
npm run lint
```

---

## üìö **DOCUMENTATION ET RESSOURCES**

### Fichiers importants
- `README.md` : Documentation g√©n√©rale
- `pydanticai.md` : Documentation PydanticAI
- `instructions/openai-instructions.md` : Sp√©cifications techniques

### R√©f√©rences
- **FastAPI** : https://fastapi.tiangolo.com/
- **PydanticAI** : https://ai.pydantic.dev/
- **Vue.js** : https://vuejs.org/
- **TypeScript** : https://www.typescriptlang.org/

---

**Version** : 1.0  
**Derni√®re mise √† jour** : 2025-01-24  
**Mainteneur** : √âquipe de d√©veloppement JdR
